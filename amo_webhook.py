#!/usr/bin/env python
# coding: utf-8

# In[ ]:


import requests
import json
from datetime import datetime

# üîπ AmoCRM –¥–∞–Ω–Ω—ã–µ
AMOCRM_ACCESS_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImYxNTYyOTVlZmYzYjI4ZjlmMjE4YTYxZmRjMjliMDMzNmZiOTJmZjJmOWNjNWQxYzI0MDNiMzRlYTI3YzVjZjRlMWUyZjBhOTgwM2VmZjM5In0.eyJhdWQiOiJkMTM3YTAzYi1lMTczLTRkMWYtOTQxMi0xMjExZDE0YmI1MWQiLCJqdGkiOiJmMTU2Mjk1ZWZmM2IyOGY5ZjIxOGE2MWZkYzI5YjAzMzZmYjkyZmYyZjljYzVkMWMyNDAzYjM0ZWEyN2M1Y2Y0ZTFlMmYwYTk4MDNlZmYzOSIsImlhdCI6MTc0MjM4NzU3NiwibmJmIjoxNzQyMzg3NTc2LCJleHAiOjE5MDAxMDg4MDAsInN1YiI6IjEyMjYwMzA2IiwiZ3JhbnRfdHlwZSI6IiIsImFjY291bnRfaWQiOjMyMjk4NTEwLCJiYXNlX2RvbWFpbiI6ImFtb2NybS5ydSIsInZlcnNpb24iOjIsInNjb3BlcyI6WyJjcm0iLCJmaWxlcyIsImZpbGVzX2RlbGV0ZSIsIm5vdGlmaWNhdGlvbnMiLCJwdXNoX25vdGlmaWNhdGlvbnMiXSwiaGFzaF91dWlkIjoiNjkxMjU4NzMtNzA4Zi00ODU5LWFkMTktNzYwZTFmMDdhOGNkIiwiYXBpX2RvbWFpbiI6ImFwaS1iLmFtb2NybS5ydSJ9.Ff9ZBKREBg1iV-GnkoubiY_BS66jJSUFpuTVqNo620SrS6jO8dDZtXe5drm3u0EYKGp97xDhGtV-HajW1QCpT3veI7V6kWW_2I_CPA-NCsSpP59K1m0E5-9thBWxiDSUVicL9s0Os-67eEqdDHWrlkNZac-qZKUj6Un4almFfCD2jYSIZhqF4dWUVziEzTRHoK8jyJfPdjqaevp4k3nhpg3EyyEtVmD-Eb67GfSmYysQvlIos1_S_pLKEWf_6HfxNB1kO4jKXcfsLzXFcVT50zMNvTlqT7_wqCD2_2fIXXqlKbGMQq7NOC_m712HQtFdrPQr5alsHNeQ9nyRpFAdJA"  # –£–±–µ—Ä–∏ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π!
AMOCRM_DOMAIN = "https://arbitrajy.amocrm.ru"
TOKEN_FIELD_ID = 898037  # ID –ø–æ–ª—è, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–∫–µ–Ω
LEAD_ID = 33794059  # ID —Ç–µ—Å—Ç–æ–≤–æ–π —Å–¥–µ–ª–∫–∏

# üîπ ID –ø–æ–ª–µ–π AmoCRM
FIELDS_MAPPING = {
    "age": 896769,
    "chainId": 896369,
    "name": 896479,
    "symbol": 896481,
    "marketCap": 896483,
    "liquidity": 896485,
    "volume": 896487,
    "telegram": 898051,
    "twitter": 898053
}

# üîπ DexScreener API URL
DEXSCREENER_API_URL = "https://api.dexscreener.com/latest/dex/tokens/"

def get_dexscreener_data(token_address):
    """–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–∫–µ–Ω–µ —Å DexScreener API."""
    url = f"{DEXSCREENER_API_URL}{token_address}"
    response = requests.get(url)
    
    if response.status_code == 200:
        data = response.json()
        if "pairs" in data and data["pairs"]:
            # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞—Ä—É —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å—é
            pair = max(data["pairs"], key=lambda x: x["liquidity"].get("usd", 0))
            
            timestamp = pair["pairCreatedAt"] / 1000  # –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            pair_created_date = datetime.utcfromtimestamp(timestamp)
            days_since_creation = (datetime.utcnow() - pair_created_date).days
            
            social_links = pair.get("info", {}).get("socials", [])
            twitter_link = next((s["url"] for s in social_links if s["type"] == "twitter"), None)
            telegram_link = next((s["url"] for s in social_links if s["type"] == "telegram"), None)
            
            return {
                "age": f"{days_since_creation} d",
                "chainId": pair["chainId"],
                "name": pair["baseToken"]["name"],
                "symbol": pair["baseToken"]["symbol"],
                "marketCap": pair.get("marketCap", "N/A"),
                "liquidity": pair["liquidity"].get("usd", 0),
                "volume": pair["volume"].get("h24", 0),
                "telegram": telegram_link,
                "twitter": twitter_link
            }
    return None

def get_lead_details(lead_id):
    """–ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ –∏–∑ AmoCRM."""
    url = f"{AMOCRM_DOMAIN}/api/v4/leads/{lead_id}"
    headers = {"Authorization": f"Bearer {AMOCRM_ACCESS_TOKEN}"}
    
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        return response.json()
    return None

def update_lead(lead_id, update_data):
    """–û–±–Ω–æ–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É –≤ AmoCRM."""
    url = f"{AMOCRM_DOMAIN}/api/v4/leads/{lead_id}"
    headers = {
        "Authorization": f"Bearer {AMOCRM_ACCESS_TOKEN}",
        "Content-Type": "application/json"
    }
    response = requests.patch(url, headers=headers, data=json.dumps(update_data))
    print("üîπ AmoCRM Response:", response.status_code, response.text)
    return response.status_code == 200

# üîπ 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–¥–µ–ª–∫—É
lead_data = get_lead_details(LEAD_ID)
if not lead_data:
    print("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏")
else:
    custom_fields = lead_data.get("custom_fields_values", [])
    token_address = None
    for field in custom_fields:
        if field["field_id"] == TOKEN_FIELD_ID:
            token_address = field["values"][0]["value"].replace("http://", "").replace("https://", "").strip()
            break
    
    if not token_address:
        print("‚ùå –û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –ø–æ–ª–µ")
    else:
        print(f"‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω: {token_address}")
        token_data = get_dexscreener_data(token_address)
        if token_data:
            print("‚úÖ –î–∞–Ω–Ω—ã–µ –æ —Ç–æ–∫–µ–Ω–µ –ø–æ–ª—É—á–µ–Ω—ã:", token_data)
            update_payload = {
                "custom_fields_values": [
                    {"field_id": FIELDS_MAPPING[key], "values": [{"value": str(value)}]}
                    for key, value in token_data.items() if key in FIELDS_MAPPING
                ]
            }
            if update_lead(LEAD_ID, update_payload):
                print("‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ AmoCRM")
            else:
                print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏")
        else:
            print("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–∫–µ–Ω–µ")

